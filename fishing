-- Auto Fish With UI (Dropdown + Toggle + Drag + Minimize)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UIS = game:GetService("UserInputService")

local Client = Players.LocalPlayer

-- ================= SETTINGS =================
local Flags = {
    Farm = "Self"
}

local Running = false
local Connections = {}

-- ================= FUNCTIONS =================

local function GetRoot(Character)
    return Character and Character:FindFirstChild("HumanoidRootPart")
end

local function GetHumanoid(Character)
    return Character and Character:FindFirstChild("Humanoid")
end

local function Cast()
    local Character = Client.Character
    if not Character then return end

    local Humanoid = GetHumanoid(Character)
    local Root = GetRoot(Character)
    if not Root then return end

    local Rod = Character:FindFirstChild("Rod")
    if not Rod then return end

    local Farming = Flags.Farm == "Self"
        and Root
        or workspace:FindFirstChild("Galaxies")
        and workspace.Galaxies:FindFirstChild(Flags.Farm)
        or Root

    local FarmPos = Farming:GetPivot().Position + Vector3.new(0, 5, 0)
    local FarmLook = Farming:GetPivot().LookVector

    ReplicatedStorage.Events.Global.Cast:FireServer(
        Humanoid,
        FarmPos,
        FarmLook,
        Rod.Model.Nodes.RodTip.Attachment
    )

    ReplicatedStorage.Events.Global.WithdrawBobber:FireServer(Humanoid)
end

-- Auto Confirm Items
local ClientRecieveItems = ReplicatedStorage.Events.Global.ClientRecieveItems
table.insert(Connections,
    ClientRecieveItems.OnClientEvent:Connect(function(...)
        local Data = {...}
        local Info = Data[4] or {}
        local TimingTbl = Data[6] or {}

        for Index, StarData in pairs(Info) do
            local Id = StarData["id"]
            if Id then
                task.wait(TimingTbl[Index] or 3)
                ReplicatedStorage.Events.Global.ClientItemConfirm:FireServer(Id)
            end
        end
    end)
)

-- ================= LOOP =================

task.spawn(function()
    while true do
        if Running then
            Cast()
        end
        task.wait(0.7) -- safer delay
    end
end)

-- ================= CLEAN UI =================

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui
ScreenGui.Name = "AutoFishUI"

local Main = Instance.new("Frame")
Main.Parent = ScreenGui
Main.Size = UDim2.new(0, 320, 0, 220)
Main.Position = UDim2.new(0.5, -160, 0.5, -110)
Main.BackgroundColor3 = Color3.fromRGB(25,25,30)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true

local Corner = Instance.new("UICorner", Main)
Corner.CornerRadius = UDim.new(0,12)

local Stroke = Instance.new("UIStroke", Main)
Stroke.Color = Color3.fromRGB(60,60,70)
Stroke.Thickness = 1

-- Title Bar
local TitleBar = Instance.new("Frame", Main)
TitleBar.Size = UDim2.new(1,0,0,40)
TitleBar.BackgroundColor3 = Color3.fromRGB(30,30,36)
TitleBar.BorderSizePixel = 0

local TitleCorner = Instance.new("UICorner", TitleBar)
TitleCorner.CornerRadius = UDim.new(0,12)

local Title = Instance.new("TextLabel", TitleBar)
Title.Size = UDim2.new(1,-40,1,0)
Title.Position = UDim2.new(0,15,0,0)
Title.Text = "Auto Fish"
Title.TextColor3 = Color3.fromRGB(220,220,220)
Title.TextSize = 18
Title.Font = Enum.Font.GothamSemibold
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left

-- Minimize Button
local Minimize = Instance.new("TextButton", TitleBar)
Minimize.Size = UDim2.new(0,30,0,30)
Minimize.Position = UDim2.new(1,-35,0.5,-15)
Minimize.Text = "-"
Minimize.Font = Enum.Font.GothamBold
Minimize.TextSize = 18
Minimize.BackgroundColor3 = Color3.fromRGB(45,45,55)
Minimize.TextColor3 = Color3.fromRGB(200,200,200)
Minimize.BorderSizePixel = 0

local MinCorner = Instance.new("UICorner", Minimize)
MinCorner.CornerRadius = UDim.new(0,8)

-- Container
local Container = Instance.new("Frame", Main)
Container.Position = UDim2.new(0,0,0,45)
Container.Size = UDim2.new(1,0,1,-45)
Container.BackgroundTransparency = 1

-- Toggle Button
local Toggle = Instance.new("TextButton", Container)
Toggle.Size = UDim2.new(0.9,0,0,40)
Toggle.Position = UDim2.new(0.05,0,0,20)
Toggle.BackgroundColor3 = Color3.fromRGB(40,40,48)
Toggle.Text = "Start Farming"
Toggle.Font = Enum.Font.GothamMedium
Toggle.TextSize = 14
Toggle.TextColor3 = Color3.fromRGB(220,220,220)
Toggle.BorderSizePixel = 0

local ToggleCorner = Instance.new("UICorner", Toggle)
ToggleCorner.CornerRadius = UDim.new(0,10)

-- Dropdown Label
local DropLabel = Instance.new("TextLabel", Container)
DropLabel.Size = UDim2.new(0.9,0,0,20)
DropLabel.Position = UDim2.new(0.05,0,0,80)
DropLabel.Text = "Farm Target"
DropLabel.Font = Enum.Font.Gotham
DropLabel.TextSize = 13
DropLabel.TextColor3 = Color3.fromRGB(180,180,180)
DropLabel.BackgroundTransparency = 1
DropLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Dropdown Button
local Dropdown = Instance.new("TextButton", Container)
Dropdown.Size = UDim2.new(0.9,0,0,35)
Dropdown.Position = UDim2.new(0.05,0,0,105)
Dropdown.BackgroundColor3 = Color3.fromRGB(40,40,48)
Dropdown.Text = Flags.Farm
Dropdown.Font = Enum.Font.Gotham
Dropdown.TextSize = 14
Dropdown.TextColor3 = Color3.fromRGB(220,220,220)
Dropdown.BorderSizePixel = 0

local DropCorner = Instance.new("UICorner", Dropdown)
DropCorner.CornerRadius = UDim.new(0,10)

-- ================= UI LOGIC =================

Toggle.MouseButton1Click:Connect(function()
    Running = not Running
    
    if Running then
        Toggle.Text = "Stop Farming"
        Toggle.BackgroundColor3 = Color3.fromRGB(70,130,255)
    else
        Toggle.Text = "Start Farming"
        Toggle.BackgroundColor3 = Color3.fromRGB(40,40,48)
    end
end)

Dropdown.MouseButton1Click:Connect(function()
    if Flags.Farm == "Self" then
        Flags.Farm = "Galaxy1"
    else
        Flags.Farm = "Self"
    end
    Dropdown.Text = Flags.Farm
end)

Minimize.MouseButton1Click:Connect(function()
    Container.Visible = not Container.Visible
    Main.Size = Container.Visible and UDim2.new(0,320,0,220) or UDim2.new(0,320,0,45)
end)

-- Toggle dropdown
DropdownButton.MouseButton1Click:Connect(function()
    ScrollFrame.Visible = not ScrollFrame.Visible
    if ScrollFrame.Visible then
        ScrollFrame.Size = UDim2.new(1, -20, 0, 120)
    else
        ScrollFrame.Size = UDim2.new(1, -20, 0, 0)
    end
end)

-- Close Button
local Close = Instance.new("TextButton", Frame)
Close.Size = UDim2.new(1, -20, 0, 30)
Close.Text = "Close & Stop"
Close.BackgroundColor3 = Color3.fromRGB(120,40,40)
Close.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", Close).CornerRadius = UDim.new(0,8)

Close.MouseButton1Click:Connect(function()
    Running = false
    ScreenGui:Destroy()
    for _, connection in ipairs(Connections) do
        connection:Disconnect()
    end
end)
